#Ралли на браузерах

Собственный проект [WB&mdash;Tech](http://wbtech.pro/) по комментированию
скриншотов [coment.me](http://coment.me/) на сегодняшний день, для получения
снимка сайта, использует связку `selenium + firefox`. Данный подход решает
задачи получения скриншота, однако тратит достаточно много памяти, и к тому же
со временем накапливается большое количество повисших процессов, что в свою
очередь приводит к подвисанию сервиса. В связи с этим, необходимо исследовать
доступные варианты и определить наилучший из браузеров для автоматического
создания скриншотов.

##Участники соревнований
На участие в ралли были отобранны следующие кандидаты:

- Firefox
- Google Chrome
- Chromium
- [Splash](http://splash.readthedocs.org/en/latest/)
- [Ghost.py](http://ghost-py.readthedocs.org/en/latest/)
- [Zombie.js](https://github.com/ryanpetrello/python-zombie/)
- [Pantom.js](http://phantomjs.org/)
- [Awesomium](http://awesomium.com/)
- [Slimer.js](http://slimerjs.org/)

Итак, участники отобраны, и готовы показать себя во всей красе, чтож &mdash;
приступим к соревнованиям.

##Трасса
>![rally](/im/rally.jpg)

Для наших, замечательных конкурсантов, предстоит пройти трек по пересеченной
местности c четырьмя крутыми поворотами с 16-ю чекпоинтами, а именно &mdash;
показать свои навыки на следующих ресурсах:

- https://google.com/
- https://www.facebook.com/
- http://habrahabr.ru/
- http://wbtech.pro/

при следующих разрешениях экранов по ширине: `240`, `780`, `1320`, `1920`
пикселей.

##Заезд первый &mdash; &laquo;Качество&raquo;
>Качество &mdash; это делать что-либо правильно, даже когда никто не смотрит.

Поскольку, в конечном счете, результат должен быть не хуже, чем имеющийся на
настоящий момент &mdash; эталоном качества будут выступать снимки огненной лисы.

На данном этапе сошли с дистанции сразу 4 участника. Причем, если бы я делал
ставки &mdash; то проиграл бы, ведь хром, которого я считал фаворитом
соревнований, оказался некомпетентным.
####Только видимая область
Для связки `selenium`а и `google chrome`
необходимо использовать `chromedriver`. И, как оказалось, мало того - что скачать
его можно только через VPN, так ещё и в нем содержится баг, который тянется с
2013 года, известным issue. Хром драйвер - не пролистывает окно браузера при
захвате изображения - а делает снимок видимой области.
>![chrome fail](/im/chrome.png)

Так что `Google Chrome` и `Chromium` не прошли данный этап.

####Неверный resize
Безголовый браузер `Splash`, запускается демоном и слушает `localhost:8050`, по
которому предоставляет `http api` управления браузером. Для сохранения скриншота
необходимо указать адрес сайта и ширину окна браузера.
```python
request = 'http://localhost:8050/render.png?\
url={url}&width={res}&render_all=1&wait=1'.format(url=url, res=res)
res = subprocess.check_call(['curl', request, '-o', save_as])
```
Однако, как оказалось, ширина окна браузера - всегда 1024px, а параметр width
&mdash; влияет только на фактическую ширину полученного изображения, к тому же
сжатого как thumbnail.
>240px<br />![splash](/im/splash.png)
><hr />
>780px<br />![splash big](/im/splash_big.png)

Так что splash не прошел данный этап.

####&laquo;Что я вообще сдесь делаю&raquo; &copy; Zombie
>![zombie](/im/zombie.jpg)

Как оказалось зомби вообще не умеет делать скриншоты.

####Фальшивые паспорта &mdash; старый гугл
Некоторые из участников соревнований, а именно Фантом и Лизун, не смогли бы
пройти все этапы ралли, под своими именами, поэтому пришлось выдать им фальшивые
паспорта.

Google выдает различные версии сайта, в зависимости от того какой user agent у
браузера запрашивающего страницу, и если этот агент неизвестный или старый, то
выдается старая версия гугл, с черной полоской меню.
>![old google](/im/old_google.png)

Но при использовании поддельных паспортов, от файрфокса результат такой как
нужно.
```python
'Mozilla/5.0 (X11; Linux x86_64) Gecko/20100101 Firefox/36.0'
```
>![google ok](/im/google.png)
