<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>report</title>
    <link rel="stylesheet" href="markdown.css" />
</head>
<body>

<article class="body">
<h1>Ралли на браузерах</h1>

<p>Собственный проект <a href="http://wbtech.pro/">WB&mdash;Tech</a> по комментированию скриншотов <a href="http://coment.me/">coment.me</a> на сегодняшний день, для получения снимка сайта, использует связку <code>selenium + firefox</code>. Данный подход решает задачи получения скриншота, однако тратит достаточно много памяти, и к тому же со временем накапливается большое количество повисших процессов, что в свою очередь приводит к подвисанию сервиса. В связи с этим, необходимо исследовать доступные варианты и определить наилучший из браузеров для автоматического создания скриншотов.</p>

<p>Критерииями для выбора победителя будут являтся:</p>

<ul>
    <li>Качество скриншотов</li>
    <li>Скорость работы</li>
    <li>Затрачиваемые ресурсы</li>
</ul>

<h2>Участники соревнований</h2>

<p>На участие в ралли были отобранны следующие кандидаты:</p>

<ul>
    <li>Firefox <code>36.0.1</code></li>
    <li>Google Chrome <code>41.0.2272.89</code></li>
    <li>Chromium <code>Not tested</code></li>
    <li><a href="http://splash.readthedocs.org/en/latest/">Splash</a> <code>1.5</code></li>
    <li><a href="http://ghost-py.readthedocs.org/en/latest/">Ghost.py</a> <code>0.1.1</code></li>
    <li><a href="https://github.com/ryanpetrello/python-zombie/">Zombie.js</a> <code>0.2.0</code></li>
    <li><a href="http://phantomjs.org/">Pantom.js</a> <code>1.9.8</code>, <code>2.0.0</code></li>
    <li><a href="http://slimerjs.org/">Slimer.js</a> <code>0.9.5</code>, <code>0.10.0pre</code></li>
</ul>

<p>Познакомимся с участниками по ближе:</p>

<ul>
    <li><em>Firefox</em> &mdash; Наиболее массовый не WebKit браузер на сегодняшний день.</li>
    <li><em>Google Chrome</em> / <em>Chromium</em> &mdash; Один из самых быстрых и популярных браузеров.</li>
    <li><em>Splash</em> &mdash; легкий браузер с поддержкой javascript реализовыннй на python-е предоставляюший для управления http api.</li>
    <li><em>Ghost.py</em> &mdash; python браузер с поддержкой javascript ориентированный на автоматическое функциональное тестирование.</li>
    <li><em>Zombie.js</em> &mdash; легкий и быстрый безголовый браузер для автоматического тестирования основаный на node.js</li>
    <li><em>Phantom.js</em> &mdash; быстрый безголовый браузер на движке WebKit со встроенной поддержкой svg. Управляется при помощи javascript api.</li>
    <li><em>Slimer.js</em> &mdash; быстрый браузер, похожий на phantomjs, однако использует движек Gecko от firefox. Управляется при помощи javascript api.</li>
</ul>

<p>Итак, участники отобраны, и готовы показать себя во всей красе, что ж &mdash; приступим к соревнованиям.</p>

<h2>Трасса</h2>

<p><img src="im/rally.jpg" alt="rally"></p>

<p>Для наших, замечательных конкурсантов, предстоит пройти трек по пересеченной местности c четырьмя крутыми поворотами с 16-ю чекпоинтами, а именно: показать свои навыки на следующих ресурсах:</p>

<ul>
    <li><a href="https://google.com/">https://google.com/</a></li>
    <li><a href="https://www.facebook.com/">https://www.facebook.com/</a></li>
    <li><a href="http://habrahabr.ru/">http://habrahabr.ru/</a></li>
    <li><a href="http://wbtech.pro/">http://wbtech.pro/</a></li>
</ul>

<p>при следующих разрешениях экранов по ширине: <code>240</code>, <code>780</code>, <code>1320</code>, <code>1920</code> пикселей.</p>

<h2>Заезд первый &mdash; &laquo;Качество&raquo;</h2>

<blockquote>
    <p>Качество &mdash; это делать что-либо правильно, даже когда никто не смотрит.</p>
</blockquote>

<p>Поскольку, в конечном счете, результат должен быть не хуже, чем имеющийся на настоящий момент &mdash; эталоном качества будут выступать снимки <code>firefox</code>-а.</p>

<p>На данном этапе сошли с дистанции сразу 4 участника. Причем, если бы я делал ставки, то проиграл бы, ведь хром, которого я считал фаворитом соревнований, оказался абсолютно некомпетентным участником.</p>

<h4>Только видимая область</h4>

<p>Для связки <code>selenium</code>-а и <code>google chrome</code> необходимо использовать <code>chromedriver</code> текущая стабильная версия <code>2.14</code>. И, как оказалось, в нем содержится баг, который тянется с 2013 года, известным <a href="https://code.google.com/p/chromedriver/issues/detail?id=294">issue</a>. Хром драйвер не пролистывает окно браузера при захвате изображения, а делает снимок видимой области.</p>

<blockquote>
    <p><img src="im/chrome.png" alt="chrome fail" class="screenshot"></p>
</blockquote>

<p>Так что <code>Google Chrome</code> и <code>Chromium</code> не прошли данный этап.</p>

<h4>Неверный resize</h4>

<p>Безголовый браузер <code>Splash</code>, запускается демоном и слушает <code>localhost:8050</code>, по которому предоставляет <code>http api</code> управления браузером. Для сохранения скриншота необходимо указать адрес сайта и ширину окна браузера.</p>

<div class="highlight highlight-python">
<pre>request <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>http://localhost:8050/render.png?<span class="pl-cce">\</span></span>
<span class="pl-s">url=<span class="pl-c1">{url}</span>&amp;width=<span class="pl-c1">{res}</span>&amp;render_all=1&amp;wait=1<span class="pl-pds">'</span></span>.format(<span class="pl-smi">url</span><span class="pl-k">=</span>url, <span class="pl-smi">res</span><span class="pl-k">=</span>res)
res <span class="pl-k">=</span> subprocess.check_call([<span class="pl-s"><span class="pl-pds">'</span>curl<span class="pl-pds">'</span></span>, request, <span class="pl-s"><span class="pl-pds">'</span>-o<span class="pl-pds">'</span></span>, save_as])</pre></div>

<p>Однако, как оказалось, ширина окна браузера всегда 1024px, а параметр <code>width</code> влияет только на фактическую ширину полученного изображения, к тому же сжатого как thumbnail.</p>

<blockquote>
    <p>240px<br><img src="im/splash.png" alt="splash" class="screenshot"></p>
    <hr>
    <p>780px<br><img src="im/splash_big.png" alt="splash big" class="screenshot"></p>
</blockquote>

<p>Так что splash не прошел данный этап.</p>

<h4>&laquo;Что я вообще сдесь делаю&raquo; &copy; Zombie</h4>

<p><img src="im/zombie.jpg" alt="zombie"></p>

<p>Как оказалось, зомби вообще не умеет делать скриншоты, поэтому выбывает из соревнований.</p>

<h4>Фальшивые паспорта &mdash; старый гугл</h4>

<p>Некоторые из участников соревнований, а именно <code>Phantom.js</code> и <code>Slimer.js</code>, не смогли бы пройти все этапы ралли, под своими именами, поэтому пришлось выдать им фальшивые паспорта.</p>

<p>Google выдает различные версии сайта, в зависимости от того: какой user agent у браузера запрашивающего страницу, и если этот агент неизвестный или старый, то выдается старая версия гугл, с черной полоской меню.</p>

<blockquote>
    <p>Phantom.js 240px<br><img src="im/old_google_phantom.png" alt="old google" class="screenshot"></p>
    <hr>
    <p>Slimer.js 240px<br><img src="im/old_google_slimer.png" alt="old google 2" class="screenshot"></p>
</blockquote>

<p>Но при использовании поддельных паспортов, от <code>firefox</code> результат такой как нужно.</p>

<div class="highlight highlight-python"><pre><span class="pl-s"><span class="pl-pds">'</span>Mozilla/5.0 (X11; Linux x86_64) Gecko/20100101 Firefox/36.0<span class="pl-pds">'</span></span></pre></div>

<blockquote>
    <p><img src="im/google.png" alt="google ok" class="screenshot"></p>
</blockquote>

<h4>Пикселизация &mdash; выколи глаза.</h4>

<p><code>Ghost.py</code> не очень хорошо умеет захватывать картинки, логотип google выглядит похожим на забор.</p>

<blockquote>
    <p><img src="im/ghost.png" alt="ghost" class="screenshot"></p>
</blockquote>

<p>Хоть это и недопустимо, однако, ограничимся предупреждением, и пропустим
призрака в следующий тур.</p>

<h3>Результаты первого заезда</h3>

<p>Во второй тур прошли 4 участника и 4 участника покинули соревнования. Турнирная таблица по окончанию первого этапа.</p>

<ul>
    <li><img class="emoji" title=":white_check_mark:" alt=":white_check_mark:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2705.png" height="20" width="20" align="absmiddle"> Firefox</li>
    <li><img class="emoji" title=":white_check_mark:" alt=":white_check_mark:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2705.png" height="20" width="20" align="absmiddle"> Pantom.js</li>
    <li><img class="emoji" title=":white_check_mark:" alt=":white_check_mark:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2705.png" height="20" width="20" align="absmiddle"> Slimer.js</li>
    <li><img class="emoji" title=":warning:" alt=":warning:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/26a0.png" height="20" width="20" align="absmiddle"> Ghost.py</li>
    <li><img class="emoji" title=":x:" alt=":x:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png" height="20" width="20" align="absmiddle"> Chromium</li>
    <li><img class="emoji" title=":x:" alt=":x:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png" height="20" width="20" align="absmiddle"> Google Chrome</li>
    <li><img class="emoji" title=":x:" alt=":x:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png" height="20" width="20" align="absmiddle"> Splash</li>
    <li><img class="emoji" title=":x:" alt=":x:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png" height="20" width="20" align="absmiddle"> Zombie.js</li>
</ul>

<h2>Заезд второй &mdash; &laquo;Скорость&raquo;</h2>

<p><img src="im/speed.jpg" alt="speed"></p>

<p>На данном этапе измерялось время, необходимое для создания браузера, открытия нужной страницы, изменения ширины окна до заданной, сохранения страницы как изображения PNG, закрытия страницы и уничтожения объекта браузера.</p>

<p>Измерения проводились при помощи стандартной библиотеки <code>time</code>, как разница времени между началом запуска функции и её окончания.</p>

<div class="highlight highlight-python"><pre><span class="pl-k">import</span> time
<span class="pl-c"># ...</span>
        start <span class="pl-k">=</span> time.time()
        <span class="pl-c"># call test browser fun()</span>
        end <span class="pl-k">=</span> time.time()
<span class="pl-c"># ...</span>
        times.append(end <span class="pl-k">-</span> start)</pre></div>

<p><img src="im/time.png" alt="time">
&lt; тут интерактивный график вместо скриншота &gt;</p>

<h3>Результаты второго заезда</h3>

<p>В ходе данного этапа, участники заняли следующие места:</p>

<ol>
    <li>Phantom.js <code>2.x</code></li>
    <li>Phantom.js <code>1.x</code></li>
    <li>Ghost.py</li>
    <li>Phantom.js <code>1.x</code> + selenium</li>
    <li>Phantom.js <code>2.x</code> + selenium</li>
    <li>Slimer.js <code>9.x</code></li>
    <li>Slimer.js <code>10.x</code></li>
    <li>Firefox + selenium</li>
</ol>

<p>В результате, ни один из участников не оказался значительно хуже чем <code>firefox</code>, поэтому выбывших нет, все переходят к следующему этапу.</p>

<h2>Заезд третий &mdash; &laquo;Ресурсы&raquo;</h2>

<p><img src="im/fuel.jpg" alt="fuel"></p>

<p>Учитывалась память, которую тратит главный процесс, и все его дочерние процессы. Память измерялась при помощи функции <code>memory_usage</code> библиотеки <code>memory_profiler</code> с указанием параметра <code>include_children</code>.</p>

<p>Измерялась минимальная, средняя, и максимальная память для каждого скриншота.</p>

<div class="highlight highlight-python"><pre><span class="pl-k">from</span> memory_profiler <span class="pl-k">import</span> memory_usage
<span class="pl-c"># ...</span>
        memory <span class="pl-k">=</span> memory_usage((fun, args), <span class="pl-smi">include_children</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
<span class="pl-c"># ...</span>
        mins.append(<span class="pl-c1">min</span>(memory))
        maxs.append(<span class="pl-c1">max</span>(memory))
        avgs.append(avg(memory))</pre></div>

<h4>Ненасытное привидение</h4>

<p><code>Ghost.py</code> &mdash; оказался чрезвычайно прожорливым, занимая всю доступную память, доходил до максимума и вылетал. Единственный из участников, кто не сумел пройти все 16 чекпоинтов за один подход.</p>

<p>Учитывая вынесенное ранее предупреждение, призрак вылетает из конкурса!</p>

<blockquote>
    <p>I ain't afraid of no ghosts</p>
</blockquote>

<p><img src="im/ghostbusters.png" alt="ghostbusters"></p>

<h4>
<a id="user-content-Двуличный-хитрец" class="anchor" href="#%D0%94%D0%B2%D1%83%D0%BB%D0%B8%D1%87%D0%BD%D1%8B%D0%B9-%D1%85%D0%B8%D1%82%D1%80%D0%B5%D1%86" aria-hidden="true"><span class="octicon octicon-link"></span></a>Двуличный хитрец</h4>

<p>Оказалось, что <code>Slimer.js</code> притворяется: запускается дочерний процесс <code>slimerjs</code>,
который потребляет не более 3&nbsp;Mb памяти, но при этом запускает ещё один
дочерний процесс с именем <code>firefox</code>, который уже добирает память до 300&nbsp;Mb.</p>

<h4>Общие затраты памяти</h4>

<p>Поскольку <code>Ghost.py</code> потребляет уж слишком много ресурсов, на графиках не указывается.</p>

<p><img src="im/max.png" alt="memory max">
&lt; тут интерактивный график вместо скриншота &gt;</p>

<p><img src="im/avg.png" alt="memory avg">
&lt; тут интерактивный график вместо скриншота &gt;</p>

<h3>Результаты третьего заезда</h3>

<p>В ходе данного этапа, участники заняли следующие места:</p>

<ol>
    <li>Phantom.js <code>1.x</code></li>
    <li>Phantom.js <code>2.x</code></li>
    <li>Phantom.js <code>1.x</code> + selenium</li>
    <li>Phantom.js <code>2.x</code> + selenium</li>
    <li>Slimer.js <code>9.x</code></li>
    <li>Slimer.js <code>10.x</code></li>
    <li>Firefox + selenium</li>
    <li>Ghost.py</li>
</ol>

<p>На этом этапе выбывает <code>Ghost.py</code>, турнирная таблица принимает вид:</p>

<ul>
    <li><img class="emoji" title=":white_check_mark:" alt=":white_check_mark:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2705.png" height="20" width="20" align="absmiddle"> Pantom.js</li>
    <li><img class="emoji" title=":white_check_mark:" alt=":white_check_mark:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2705.png" height="20" width="20" align="absmiddle"> Slimer.js</li>
    <li><img class="emoji" title=":white_check_mark:" alt=":white_check_mark:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2705.png" height="20" width="20" align="absmiddle"> Firefox</li>
    <li><img class="emoji" title=":x:" alt=":x:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/274c.png" height="20" width="20" align="absmiddle"> Ghost.py</li>
</ul>

<h2>Заезд четвертый &mdash; &laquo;Управляемость&raquo;</h2>

<p><img src="im/wet_road.png" alt="wet road"></p>

<p>Несмотря на то, что определилась тройка лидеров и уже можно подвести итоги, рассмотрим как управлять безголовыми браузерами.</p>

<h4>Firefox</h4>

<p><code>Firefox</code> работает в связке с <code>selenium</code>-ом и управляется достаточно просто, единственная особенность &mdash; это то, что браузер запускает графическую оболочку, поэтому нужно использовать виртуальный дисплей.</p>

<div class="highlight highlight-python"><pre><span class="pl-k">from</span> selenium <span class="pl-k">import</span> webdriver
<span class="pl-k">from</span> pyvirtualdisplay <span class="pl-k">import</span> Display
<span class="pl-c"># ...</span>
<span class="pl-k">with</span> Display(<span class="pl-smi">visible</span><span class="pl-k">=</span><span class="pl-c1">0</span>, <span class="pl-smi">size</span><span class="pl-k">=</span>(<span class="pl-c1">1024</span>, <span class="pl-c1">768</span>), <span class="pl-smi">backend</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>xvfb<span class="pl-pds">'</span></span>):
        browser <span class="pl-k">=</span> Browser(<span class="pl-k">**</span>param)
        browser.set_window_size(width, <span class="pl-c1">768</span>)
        browser.get(url)
        browser.save_screenshot(save_as)
        browser.quit()</pre></div>

<h4>Phantom</h4>

<p><code>Phantom.js</code> можно использовать, как самостоятельный безголовый браузер, так и в связке с <code>selenium</code>-ом. Работа с <code>selenium</code>-ом аналогична <code>firefox</code>, за тем лишь исключением, что нет необходимости запускать виртуальный дисплей.</p>

<p>Собственная работа <code>phantom.js</code>, заключается в вызове консольной команды, и передаче ей скрипта для выполнения браузером.</p>

<div class="highlight highlight-javascript"><pre><span class="pl-k">var</span> page <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>webpage<span class="pl-pds">'</span></span>).create();
page.settings.<span class="pl-c1">userAgent</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Mozilla/5.0 (X11; Linux x86_64) Firefox/36.0<span class="pl-pds">'</span></span>;
page.viewportSize <span class="pl-k">=</span> { width<span class="pl-k">:</span><span class="pl-c1">1920</span>, height<span class="pl-k">:</span><span class="pl-c1">768</span> };
page.<span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">'</span>http://wbtech.pro/<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">status</span>) {
        page.render(<span class="pl-s"><span class="pl-pds">'</span>img/phantomjs2-no_selenium/wbtech.pro-1920px.png<span class="pl-pds">'</span></span>);
        phantom.exit();
});</pre></div>

<p>В python запускаем браузер с помощью стандартной библиотеки <code>subprocess</code>.</p>

<div class="highlight highlight-python"><pre><span class="pl-k">import</span> subprocess
<span class="pl-c"># ...</span>
subprocess.check_call([phantom_path, script_path, <span class="pl-s"><span class="pl-pds">'</span>--ssl-protocol=any<span class="pl-pds">'</span></span>])</pre></div>

<h4>Slimer</h4>

<p><code>Slimer.js</code> работает точно так же, как и <code>phantom.js</code> без <code>selenium</code>-а, но является не совсем безголовым, он запускает графическую оболочку, поэтому требует виртуальный дисплей.</p>

<p>А так же, в ходе тестирования было выявлено, что для корректного скриншота нужно всегда, перед открытием страницы, указывать базовую ширину окна браузера.</p>

<div class="highlight highlight-javascript"><pre><span class="pl-k">var</span> page <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>webpage<span class="pl-pds">'</span></span>).create();
page.viewportSize <span class="pl-k">=</span> { width<span class="pl-k">:</span><span class="pl-c1">1024</span>, height<span class="pl-k">:</span><span class="pl-c1">768</span> };
page.settings.<span class="pl-c1">userAgent</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Mozilla/5.0 (X11; Linux x86_64) Firefox/36.0<span class="pl-pds">'</span></span>;
page.<span class="pl-c1">open</span>(<span class="pl-s"><span class="pl-pds">'</span>http://wbtech.pro/<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">status</span>) {
        page.viewportSize <span class="pl-k">=</span> { width<span class="pl-k">:</span><span class="pl-c1">1920</span>, height<span class="pl-k">:</span><span class="pl-c1">768</span> };
        page.render(<span class="pl-s"><span class="pl-pds">'</span>img/slimerjs10/wbtech.pro-1920px.png<span class="pl-pds">'</span></span>);
        page.<span class="pl-c1">close</span>();
        slimer.exit();
});</pre></div>

<p>В python запускаем браузер с помощью стандартной библиотеки <code>subprocess</code>.</p>

<div class="highlight highlight-python"><pre><span class="pl-k">from</span> pyvirtualdisplay <span class="pl-k">import</span> Display
<span class="pl-k">import</span> subprocess
<span class="pl-c"># ...</span>
<span class="pl-k">with</span> Display(<span class="pl-smi">visible</span><span class="pl-k">=</span><span class="pl-c1">0</span>, <span class="pl-smi">size</span><span class="pl-k">=</span>(<span class="pl-c1">1024</span>, <span class="pl-c1">768</span>), <span class="pl-smi">backend</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>xvfb<span class="pl-pds">'</span></span>):
        subprocess.check_call([slimer_path, script_path, <span class="pl-s"><span class="pl-pds">'</span>--ssl-protocol=any<span class="pl-pds">'</span></span>])</pre></div>

<h2>Финиш</h2>

<p><img src="im/chess_flag.png" alt="chess flag"></p>

<p>Гонка завершилась, пришло время подвести итоги и определить победителей.</p>

<p>До финиша доехали всего три команды, так что тройка лидеров очевидна. Учитывая затраты ресурсов и времени, участники занимают следующие места:</p>

<ol>
    <li>Phantom.js <code>2.x</code></li>
    <li>Phantom.js <code>1.x</code></li>
    <li>Phantom.js <code>1.x</code> + selenium</li>
    <li>Phantom.js <code>2.x</code> + selenium</li>
    <li>Slimer.js <code>9.x</code></li>
    <li>Slimer.js <code>10.x</code></li>
    <li>Firefox + selenium</li>
</ol>

<p>Безоговорочным лидером гонки стал <code>phantom.js</code>, в качестве награды ему будет предложено занять пост <code>firefox</code>-а, на сервисе <a href="http://coment.me/">coment.me</a>.</p>

<p><img src="im/pedestal.png" alt="pedestal"></p>
</article>

</body>
</html>
